<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æ‰‹æ–é£²å¤§æˆ° 2026 ğŸ¥¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        :root { --safe-top: env(safe-area-inset-top, 0px); }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: contain;
            background-color: #f9fafb;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-pt { padding-top: calc(1.5rem + var(--safe-top)); }
        .animate-pop { animation: pop 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.96); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .btn-active:active { transform: scale(0.92); filter: brightness(0.9); }
        .gold-border {
            border: 3px solid transparent;
            background-image: linear-gradient(white, white), radial-gradient(circle at top left, #facc15, #eab308);
            background-origin: border-box;
            background-clip: padding-box, border-box;
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeFirestore, collection, doc, setDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGLiEBZHVF_SejFPQx2POpIFOGrVw3WsI",
            authDomain: "drink-ca906.firebaseapp.com",
            projectId: "drink-ca906",
            storageBucket: "drink-ca906.firebasestorage.app",
            messagingSenderId: "102325799308",
            appId: "1:102325799308:web:8a4cabc8c0d622a3efeea9",
            measurementId: "G-ESTFV831NZ"
        };
        const id = 'drink-tracker-battle-2026';

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = initializeFirestore(app, { experimentalForceLongPolling: true });
            window.fb = { db, auth, appId: id, collection, doc, setDoc, onSnapshot, addDoc, deleteDoc, signInAnonymously };
        } catch (e) {
            console.error("Firebase é€£ç·šå¤±æ•—", e);
            window.fb = null;
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const ICE_LEVELS = ['æ­£å¸¸å†°', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å®Œå…¨å»å†°', 'ç†±'];
        const SWEETNESS_LEVELS = ['æ­£å¸¸ç³–', 'ä¸ƒåˆ†ç³–', 'åŠç³–', 'ä¸‰åˆ†ç³–', 'å¾®ç³–', 'ç„¡ç³–'];
        const AVATAR_OPTIONS = ['ğŸ¥¤', 'ğŸ§‹', 'ğŸ§', 'ğŸ¦¸â€â™€ï¸', 'ğŸ±', 'ğŸ¶', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¨', 'ğŸ¯', 'ğŸ¸', 'ğŸ¦„', 'ğŸŒˆ', 'ğŸ”¥', 'âœ¨', 'ğŸ€', 'ğŸ•', 'ğŸ°', 'ğŸ¸', 'ğŸ®'];
        
        const const DEFAULT_STORES = ['50åµ', 'Cocoéƒ½å¯', 'è¿·å®¢å¤', 'å¯ä¸å¯ç†Ÿæˆç´…èŒ¶', 'èŒ¶æ¹¯æœƒ', 'æ¸…å¿ƒç¦å…¨', 'å¾—æ­£', 'éº»å¤èŒ¶åŠ', 'äº”æ¡è™Ÿ', 'ä¸€èŠ³', 'é¾œè¨˜', 'çç…®ä¸¹','å¤§è‹‘å­', 'è¬æ³¢', 'é¶´èŒ¶æ¨“', 'å†ç¡5åˆ†é˜', 'å…«æ›œå’ŒèŒ¶', 'çƒå¼„', 'æ‹¾æ±£èŒ¶å±‹', 'ç´„ç¿°ç´…èŒ¶å…¬å¸', 'ä¸ƒç›èŒ¶', 'ä¸Šå®‡æ—', 'å…ˆå–é“', 'SOMA', 'åº·é’é¾', 'é®®èŒ¶é“', 'è€è³´èŒ¶æ£§', 'æœ‰é£²', 'æ˜¥æ°´å ‚', 'å¤©ä»èŒ—èŒ¶', 'å®å“¥èŒ¶é£²', 'æ°´å··èŒ¶å¼„', 'æ—¥å‡ºèŒ¶å¤ª', 'åŠŸå¤«èŒ¶', 'éº¥å‰'];
        const DEFAULT_ITEMS = ['çç å¥¶èŒ¶', 'ç¶“å…¸ç´…èŒ¶', 'çƒé¾æ‹¿éµ', 'ç¿¡ç¿ æª¸æª¬', 'å¤šå¤šç¶ èŒ¶', 'èŠèŠè‘¡è„', 'ç†Ÿæˆæ‹¿éµ', 'ç„™èŒ¶æ‹¿éµ', 'é‡‘è±èŒ¶','éµè§€éŸ³', 'å››å­£æ˜¥', 'æ¥Šæç”˜éœ²', 'æ³¢éœ¸é®®å¥¶èŒ¶', 'æ»¿æ¯ç´…æŸš', 'æŸ³æ©™ç¶ èŒ¶', 'æµ·é¹½å¥¶è“‹ç´…èŒ¶', 'èŠ‹åœ“é®®å¥¶', 'ä»™è‰å‡å¥¶èŒ¶', 'å¸ƒä¸å¥¶èŒ¶', 'é»‘ç³–çç é®®å¥¶', 'è•éº¥èŒ¶', 'ç”˜è”—é’èŒ¶', 'èŠèŠè‰è“', 'èœ‚èœœæª¸æª¬', 'æ¡‚èŠ±çƒé¾', 'å†¬ç“œé’èŒ¶'];

        const THEME_MAP = {
            pink: { primary: 'bg-pink-400', secondary: 'bg-pink-50', text: 'text-pink-600', accent: 'bg-pink-500', light: 'bg-pink-100' },
            yellow: { primary: 'bg-amber-400', secondary: 'bg-amber-50', text: 'text-amber-600', accent: 'bg-amber-500', light: 'bg-amber-100' },
            blue: { primary: 'bg-sky-400', secondary: 'bg-sky-50', text: 'text-sky-600', accent: 'bg-sky-500', light: 'bg-sky-100' },
            green: { primary: 'bg-emerald-400', secondary: 'bg-emerald-50', text: 'text-emerald-600', accent: 'bg-emerald-500', light: 'bg-emerald-100' },
            purple: { primary: 'bg-purple-400', secondary: 'bg-purple-50', text: 'text-purple-600', accent: 'bg-purple-500', light: 'bg-purple-100' },
            orange: { primary: 'bg-orange-400', secondary: 'bg-orange-50', text: 'text-orange-600', accent: 'bg-orange-500', light: 'bg-orange-100' },
            indigo: { primary: 'bg-indigo-400', secondary: 'bg-indigo-50', text: 'text-indigo-600', accent: 'bg-indigo-500', light: 'bg-indigo-100' }
        };

        const Icon = ({ name, size = 18 }) => {
            const icons = {
                Calendar: "ğŸ“…", List: "ğŸ“œ", Stats: "ğŸ“Š", Battle: "âš”ï¸", 
                User: "ğŸ‘¤", Plus: "â•", Trash: "ğŸ—‘ï¸", X: "âŒ", 
                Flame: "ğŸ”¥", Wallet: "ğŸ’°", Note: "ğŸ“", Sparkles: "âœ¨", 
                Logout: "ğŸšª", Medal: "ğŸ¥‡", Cup: "ğŸ¥¤"
            };
            return <span style={{ fontSize: size + 'px' }} className="mr-1">{icons[name] || ''}</span>;
        };

        function App() {
            const [view, setView] = useState('login'); 
            const [activeUserId, setActiveUserId] = useState(null);
            const [users, setUsers] = useState([
                { id: 'abby', name: 'Abby', color: 'yellow', icon: 'ğŸ§' },
                { id: 'carey', name: 'Carey', color: 'pink', icon: 'ğŸ¦¸â€â™€ï¸' }
            ]);
            const [logs, setLogs] = useState([]);
            
            // è‡ªå‹•åµæ¸¬ä»Šæ—¥æ—¥æœŸ
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            
            const [currentDate, setCurrentDate] = useState(new Date(now.getFullYear(), now.getMonth(), 1));
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            const [isAiCalculating, setIsAiCalculating] = useState(false);
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [newUserName, setNewUserName] = useState('');
            const [newUserColor, setNewUserColor] = useState('blue');
            const [newUserIcon, setNewUserIcon] = useState('ğŸ¥¤');
            const [statsRange, setStatsRange] = useState({ 
                start: `${now.getFullYear()}-01-01`, 
                end: `${now.getFullYear()}-12-31` 
            });
            const [formData, setFormData] = useState({ store: '', item: '', ice: 'å¾®å†°', sweetness: 'å¾®ç³–', price: '', calories: '', note: '' });

            const lastAiCombo = useRef("");

            const suggestions = useMemo(() => {
                const historyStores = [...new Set(logs.map(l => l.store))].filter(Boolean);
                const historyItems = [...new Set(logs.map(l => l.item))].filter(Boolean);
                return {
                    stores: [...new Set([...DEFAULT_STORES, ...historyStores])],
                    items: [...new Set([...DEFAULT_ITEMS, ...historyItems])]
                };
            }, [logs]);

            const runAiCal = async () => {
                const combo = `${formData.store}-${formData.item}-${formData.sweetness}`;
                if (!formData.store || !formData.item || combo === lastAiCombo.current) return;
                const apiKey = ""; 
                if (!apiKey) return;
                setIsAiCalculating(true);
                lastAiCombo.current = combo;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `åº—åï¼š${formData.store}ï¼Œå“é …ï¼š${formData.item}ï¼Œç”œåº¦ï¼š${formData.sweetness}ã€‚ä¼°è¨ˆé€™æ¯æ‰‹æ–é£²çš„ç¸½ç†±é‡kcalï¼Ÿåªå›å‚³æ•¸å­—ã€‚` }] }],
                            systemInstruction: { parts: [{ text: "ä½ æ˜¯æ‰‹æ–é£²ç‡Ÿé¤Šå¸«ï¼Œè«‹æ ¹æ“šå“é …èˆ‡ç”œåº¦ä¼°è¨ˆç†±é‡ï¼Œåªå›å‚³æ•´æ•¸æ•¸å­—ï¼Œä¸è¦æœ‰ä»»ä½•æ–‡å­—ã€‚" }] }
                        })
                    });
                    const data = await res.json();
                    const num = data.candidates?.[0]?.content?.parts?.[0]?.text?.match(/\d+/);
                    if (num) setFormData(p => ({ ...p, calories: num[0] }));
                } catch (e) { console.error("AI è¨ˆç®—å¤±æ•—", e); } finally { setIsAiCalculating(false); }
            };

            useEffect(() => {
                if (isModalOpen && formData.store && formData.item) {
                    const t = setTimeout(runAiCal, 1500);
                    return () => clearTimeout(t);
                }
            }, [formData.store, formData.item, formData.sweetness, isModalOpen]);

            useEffect(() => {
                const init = setInterval(() => {
                    if (window.fb) {
                        clearInterval(init);
                        const { auth, db, appId, collection, onSnapshot, signInAnonymously } = window.fb;
                        signInAnonymously(auth).then(() => {
                            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), snap => {
                                setLogs(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                            });
                            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), snap => {
                                if (snap.docs.length > 0) {
                                    const custom = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                    setUsers(prev => {
                                        const base = prev.filter(u => u.id === 'abby' || u.id === 'carey');
                                        const ids = new Set(base.map(u => u.id));
                                        return [...base, ...custom.filter(u => !ids.has(u.id))];
                                    });
                                }
                            });
                        }).catch(e => console.error("Firebase Login Failed", e));
                    }
                }, 500);
                return () => clearInterval(init);
            }, []);

            const activeUser = users.find(u => u.id === activeUserId);
            const theme = activeUser ? (THEME_MAP[activeUser.color] || THEME_MAP.yellow) : THEME_MAP.yellow;

            const battleStats = useMemo(() => {
                const results = users.map(u => {
                    const f = logs.filter(l => l.userId === u.id && l.date >= statsRange.start && l.date <= statsRange.end);
                    return {
                        id: u.id, name: u.name, color: u.color, icon: u.icon,
                        count: f.length,
                        cost: f.reduce((a, b) => a + Number(b.price || 0), 0),
                        calories: f.reduce((a, b) => a + Number(b.calories || 0), 0)
                    };
                });
                return {
                    countRank: [...results].sort((a,b) => b.count - a.count),
                    costRank: [...results].sort((a,b) => b.cost - a.cost),
                    calRank: [...results].sort((a,b) => b.calories - a.calories)
                };
            }, [logs, users, statsRange]);

            const usedColors = users.map(u => u.color);
            const usedIcons = users.map(u => u.icon);
            const availableColors = Object.keys(THEME_MAP).filter(c => !usedColors.includes(c));
            const availableIcons = AVATAR_OPTIONS.filter(i => !usedIcons.includes(i));

            if (view === 'login' || !activeUserId) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-8 bg-amber-50 animate-pop">
                        <div className="text-center mb-10 safe-pt">
                            <h1 className="text-4xl font-black text-amber-900 mb-3">ğŸ¥¤ æˆ‘è¶…æ„›å–æ‰‹æ–</h1>
                            <p className="text-amber-700 font-medium">æ˜¯èª°è¦ä¾†ç´€éŒ„ç½ªæƒ¡æ„Ÿï¼Ÿ</p>
                        </div>
                        <div className="grid grid-cols-2 gap-6 w-full max-w-sm">
                            {users.map(u => (
                                <button key={u.id} onClick={() => { setActiveUserId(u.id); setView('calendar'); }}
                                    className={`aspect-square rounded-[2.5rem] flex flex-col items-center justify-center shadow-lg transition-all btn-active ${THEME_MAP[u.color]?.primary || 'bg-gray-400'} text-white`}>
                                    <div className="text-5xl mb-2">{u.icon || 'ğŸ‘¤'}</div>
                                    <span className="font-black text-lg">{u.name}</span>
                                </button>
                            ))}
                            {availableColors.length > 0 && availableIcons.length > 0 && (
                                <button onClick={() => {
                                    setNewUserColor(availableColors[0]);
                                    setNewUserIcon(availableIcons[0]);
                                    setIsAddingUser(true);
                                }}
                                    className="aspect-square rounded-[2.5rem] flex flex-col items-center justify-center shadow-lg border-4 border-dashed border-amber-200 text-amber-300 active:border-amber-400">
                                    <span className="text-4xl mb-1">+</span>
                                    <span className="font-bold">æ–°å¢æˆ°å‹</span>
                                </button>
                            )}
                        </div>
                        {isAddingUser && (
                            <div className="fixed inset-0 z-[600] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
                                <div className="bg-white rounded-[3rem] w-full max-w-sm p-8 shadow-2xl space-y-6 animate-pop max-h-[90vh] overflow-y-auto no-scrollbar">
                                    <h3 className="text-2xl font-black text-center">åŠ å…¥æ‰‹æ–æˆ°å‹</h3>
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-gray-400 ml-2">é¸æ“‡å¤§å</label>
                                        <input type="text" placeholder="ä½ çš„ç¨±å‘¼" className="w-full p-4 bg-gray-50 rounded-2xl outline-none" value={newUserName} onChange={e => setNewUserName(e.target.value)} />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-gray-400 ml-2">é¸æ“‡é¡è‰²</label>
                                        <div className="flex flex-wrap gap-2 justify-center bg-gray-50 p-3 rounded-2xl">
                                            {availableColors.map(c => (
                                                <button key={c} onClick={() => setNewUserColor(c)} className={`w-8 h-8 rounded-full ${THEME_MAP[c].primary} ${newUserColor === c ? 'ring-4 ring-gray-300 scale-110' : 'opacity-60'}`} />
                                            ))}
                                        </div>
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-gray-400 ml-2">é¸æ“‡é ­è²¼</label>
                                        <div className="grid grid-cols-4 gap-2 bg-gray-50 p-3 rounded-2xl">
                                            {availableIcons.map(a => (
                                                <button key={a} onClick={() => setNewUserIcon(a)} className={`text-2xl p-2 rounded-xl ${newUserIcon === a ? 'bg-white shadow-sm scale-110' : 'opacity-40'}`}>{a}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => setIsAddingUser(false)} className="flex-1 py-3 font-bold text-gray-400">å–æ¶ˆ</button>
                                        <button onClick={async () => {
                                            if (!newUserName || !window.fb) return;
                                            const { db, appId, doc, setDoc } = window.fb;
                                            const nid = `u_${Date.now()}`;
                                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', nid), { id: nid, name: newUserName, color: newUserColor, icon: newUserIcon });
                                            setNewUserName(''); setIsAddingUser(false);
                                        }} className="flex-1 py-3 font-black bg-blue-500 text-white rounded-2xl shadow-md">åŠ å…¥å°æ±º</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className={`min-h-screen ${theme.secondary} transition-colors duration-500 pb-24`}>
                    <header className={`${theme.primary} safe-pt pb-14 px-8 rounded-b-[3.5rem] shadow-xl text-white relative`}>
                        <div className="flex justify-between items-center max-w-xl mx-auto">
                            <div className="flex items-center gap-3">
                                <div className="text-4xl drop-shadow-md">{activeUser.icon}</div>
                                <div><h1 className="text-2xl font-black">å—¨ï¼Œ{activeUser.name} âœ¨</h1><p className="text-sm opacity-80">ä»Šå¤©èª°æ˜¯æ‰‹æ–å† è»ï¼Ÿ</p></div>
                            </div>
                            <button onClick={() => setView('login')} className="bg-white/20 p-3 rounded-full backdrop-blur-md btn-active"><Icon name="Logout" /></button>
                        </div>
                    </header>
                    <nav className="max-w-xl mx-auto px-6 -mt-7 relative z-10">
                        <div className="bg-white rounded-[2rem] shadow-xl p-2 flex gap-1 border border-white/50">
                            {['calendar', 'list', 'battle', 'stats'].map(t => (
                                <button key={t} onClick={() => setView(t)} className={`flex-1 py-4 rounded-2xl font-black text-[10px] sm:text-xs transition-all ${view === t ? `${theme.primary} text-white shadow-md` : 'text-gray-300'}`}>
                                    <Icon name={t.charAt(0).toUpperCase() + t.slice(1)} size={14} />
                                    {t === 'calendar' ? 'æœˆæ›†' : t === 'list' ? 'æ¸…å–®' : t === 'battle' ? 'å¤§è³½' : 'åˆ†æ'}
                                </button>
                            ))}
                        </div>
                    </nav>
                    <main className="max-w-xl mx-auto p-4 mt-4">
                        {view === 'calendar' && (
                            <div className="bg-white rounded-[2.5rem] shadow-lg p-6 animate-pop">
                                <div className="flex items-center justify-between mb-8 px-2">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="text-gray-300 text-2xl font-bold p-2">â—€</button>
                                    <h2 className="text-xl font-black text-gray-700">{currentDate.getFullYear()} å¹´ {currentDate.getMonth()+1} æœˆ</h2>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="text-gray-300 text-2xl font-bold p-2">â–¶</button>
                                </div>
                                <div className="grid grid-cols-7 gap-2">
                                    {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(w => <div key={w} className="text-center text-[10px] font-bold text-gray-200 mb-2">{w}</div>)}
                                    {(() => {
                                        const y = currentDate.getFullYear(), m = currentDate.getMonth();
                                        const total = new Date(y, m + 1, 0).getDate();
                                        const offset = new Date(y, m, 1).getDay();
                                        const cells = [];
                                        for(let i=0; i<offset; i++) cells.push(<div key={`e-${i}`} />);
                                        for(let d=1; d<=total; d++) {
                                            const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                            const dayLogs = logs.filter(l => l.date === ds);
                                            const isToday = ds === todayStr;
                                            
                                            cells.push(
                                                <div key={d} onClick={() => { setSelectedDate(ds); setIsModalOpen(true); const ex = logs.find(l => l.date === ds && l.userId === activeUserId); setFormData(ex ? {...ex} : {store:'', item:'', ice:'å¾®å†°', sweetness:'å¾®ç³–', price:'', calories:'', note:''}); }} 
                                                    className={`aspect-square rounded-2xl flex flex-col items-center justify-center border transition-all btn-active relative 
                                                    ${isToday ? 'ring-2 ring-indigo-400 bg-indigo-50/50 border-indigo-100 shadow-sm' : 'border-gray-50 active:bg-gray-100'}`}>
                                                    <span className={`text-xs font-bold ${isToday ? 'text-indigo-600' : 'text-gray-400'}`}>{d}</span>
                                                    <div className="flex gap-0.5 mt-1 overflow-hidden px-1">
                                                        {dayLogs.slice(0, 3).map(l => (
                                                            <div key={l.id} className={`w-1.5 h-1.5 rounded-full ${THEME_MAP[l.userColor]?.accent || 'bg-gray-300'}`} />
                                                        ))}
                                                    </div>
                                                    {isToday && <div className="absolute -top-1 -right-1 text-[8px]">â­</div>}
                                                </div>
                                            );
                                        }
                                        return cells;
                                    })()}
                                </div>
                            </div>
                        )}
                        {view === 'list' && (
                            <div className="space-y-4 animate-pop">
                                {logs.filter(l => l.userId === activeUserId).sort((a,b) => b.date.localeCompare(a.date)).length > 0 ? (
                                    logs.filter(l => l.userId === activeUserId).sort((a,b) => b.date.localeCompare(a.date)).map(log => (
                                        <div key={log.id} className="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 flex items-center gap-4 animate-pop">
                                            <div className={`w-12 h-12 rounded-2xl ${theme.light} flex items-center justify-center text-xl`}>ğŸ¥¤</div>
                                            <div className="flex-1">
                                                <div className="flex justify-between"><h4 className="font-black text-gray-800">{log.item}</h4><span className="text-[10px] font-bold text-gray-300">{log.date}</span></div>
                                                <p className="text-xs text-gray-400 font-medium">{log.store} Â· {log.sweetness} Â· {log.ice}</p>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-black text-lg">${log.price}</div>
                                                <div className="text-[10px] font-bold text-orange-400">ğŸ”¥{log.calories}k</div>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-20 text-gray-300 font-bold italic">ç›®å‰çš„æ¸…å–®æ˜¯ç©ºçš„å–”...</div>
                                )}
                            </div>
                        )}
                        {view === 'battle' && (
                            <div className="space-y-6 animate-pop">
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-md">
                                    <h3 className="font-black text-gray-700 mb-4 flex items-center gap-2"><Icon name="Battle" /> æ‰‹æ–å°æ±ºå¤§è³½</h3>
                                    <div className="grid grid-cols-2 gap-2 mb-4">
                                        <input type="date" className="p-3 bg-gray-50 rounded-xl text-[10px] font-bold outline-none" value={statsRange.start} onChange={e => setStatsRange({...statsRange, start: e.target.value})} />
                                        <input type="date" className="p-3 bg-gray-50 rounded-xl text-[10px] font-bold outline-none" value={statsRange.end} onChange={e => setStatsRange({...statsRange, end: e.target.value})} />
                                    </div>
                                    <div className="space-y-6">
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-2 text-sm font-black text-gray-600">ğŸ† èª°å–æœ€å¤šæ¯ï¼Ÿ</div>
                                            {battleStats.countRank.map((res, i) => (
                                                <div key={res.id} className={`flex items-center justify-between p-4 rounded-2xl ${i === 0 ? 'gold-border shadow-md' : 'bg-gray-50'}`}>
                                                    <div className="flex items-center gap-3"><span className="text-lg">{i === 0 ? 'ğŸ‘‘' : i + 1}</span><span className="text-xl">{res.icon}</span><span className={`font-black ${THEME_MAP[res.color]?.text}`}>{res.name}</span></div>
                                                    <div className="font-black text-xl">{res.count} <span className="text-xs font-normal text-gray-400">æ¯</span></div>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-2 text-sm font-black text-gray-600">ğŸ’° èª°èŠ±æœ€å¤šéŒ¢ï¼Ÿ</div>
                                            {battleStats.costRank.map((res, i) => (
                                                <div key={res.id} className={`flex items-center justify-between p-4 rounded-2xl ${i === 0 ? 'bg-amber-100 border-2 border-amber-300' : 'bg-gray-50 opacity-80'}`}>
                                                    <div className="flex items-center gap-3"><span className="text-lg">{i === 0 ? 'ğŸ¤‘' : i + 1}</span><span className="text-xl">{res.icon}</span><span className={`font-black ${THEME_MAP[res.color]?.text}`}>{res.name}</span></div>
                                                    <div className="font-black text-xl">${res.cost}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {view === 'stats' && (
                            <div className="space-y-6 animate-pop">
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-md">
                                    <h3 className="font-black text-gray-700 mb-4 flex items-center gap-2">å€‹äººæœŸé–“çµ±è¨ˆ</h3>
                                    <div className="grid grid-cols-2 gap-2 mb-6">
                                        <input type="date" className="p-3 bg-gray-50 rounded-xl text-[10px] font-bold outline-none" value={statsRange.start} onChange={e => setStatsRange({...statsRange, start: e.target.value})} />
                                        <input type="date" className="p-3 bg-gray-50 rounded-xl text-[10px] font-bold outline-none" value={statsRange.end} onChange={e => setStatsRange({...statsRange, end: e.target.value})} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-gray-50 p-6 rounded-[2rem] text-center">
                                            <div className="text-[10px] font-bold text-gray-400 mb-1 uppercase">ç´¯è¨ˆæ¯æ•¸</div>
                                            <div className={`text-3xl font-black ${theme.text}`}>{battleStats.countRank.find(x => x.id === activeUserId)?.count || 0}</div>
                                        </div>
                                        <div className="bg-gray-50 p-6 rounded-[2rem] text-center">
                                            <div className="text-[10px] font-bold text-gray-400 mb-1 uppercase">ç´¯è¨ˆèŠ±è²»</div>
                                            <div className="text-3xl font-black text-gray-800">${battleStats.costRank.find(x => x.id === activeUserId)?.cost || 0}</div>
                                        </div>
                                        <div className="col-span-2 bg-orange-50 p-6 rounded-[2rem] text-center">
                                            <div className="text-[10px] font-bold text-orange-300 mb-1 uppercase">ç´¯è¨ˆæ”å–ç†±é‡</div>
                                            <div className="text-3xl font-black text-orange-500">{battleStats.calRank.find(x => x.id === activeUserId)?.calories || 0} kcal</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[1000] flex items-end justify-center p-0">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setIsModalOpen(false)} />
                            <div className="relative bg-white w-full max-w-xl rounded-t-[3.5rem] p-8 pb-12 animate-in slide-in-from-bottom duration-300 shadow-2xl overflow-y-auto max-h-[94vh] no-scrollbar">
                                <div className="w-12 h-1.5 bg-gray-100 rounded-full mx-auto mb-8" />
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    if (!window.fb) return;
                                    const { db, appId, doc, setDoc, collection, addDoc } = window.fb;
                                    const payload = { ...formData, price: Number(formData.price), calories: Number(formData.calories), userId: activeUserId, userName: activeUser.name, userColor: activeUser.color, userIcon: activeUser.icon, date: selectedDate, updatedAt: Date.now() };
                                    const ex = logs.find(l => l.date === selectedDate && l.userId === activeUserId);
                                    if (ex) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', ex.id), payload);
                                    else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), payload);
                                    setIsModalOpen(false);
                                }} className="space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-gray-300 ml-2">åº—å®¶</label>
                                            <input list="store-list" placeholder="åº—å®¶ (ä¾‹å¦‚: Coco)" className="w-full p-4 bg-gray-50 rounded-2xl outline-none" value={formData.store} onChange={e => setFormData({...formData, store: e.target.value})} required />
                                            <datalist id="store-list">
                                                {suggestions.stores.map(s => <option key={s} value={s} />)}
                                            </datalist>
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-gray-300 ml-2">é£²æ–™</label>
                                            <input list="item-list" placeholder="é£²æ–™ (ä¾‹å¦‚: çå¥¶)" className="w-full p-4 bg-gray-50 rounded-2xl outline-none" value={formData.item} onChange={e => setFormData({...formData, item: e.target.value})} required />
                                            <datalist id="item-list">
                                                {suggestions.items.map(i => <option key={i} value={i} />)}
                                            </datalist>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-gray-300 ml-2">é‡‘é¡</label>
                                            <input type="number" placeholder="é‡‘é¡" className="w-full p-4 bg-gray-50 rounded-2xl outline-none" value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} required />
                                        </div>
                                        <div className="space-y-1">
                                            <label className="text-[10px] font-black text-gray-300 ml-2">ç†±é‡ (AI è‡ªå‹•)</label>
                                            <div className="relative">
                                                <input type="number" placeholder="ç†±é‡" className="w-full p-4 bg-gray-100 rounded-2xl outline-none text-orange-500 font-bold" value={formData.calories} onChange={e => setFormData({...formData, calories: e.target.value})} />
                                                {isAiCalculating && <div className="absolute right-3 top-4 text-xs animate-spin text-orange-400">â³</div>}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="space-y-3">
                                        <label className="text-xs font-black text-gray-300 ml-2">å†°å¡Š / ç”œåº¦</label>
                                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                                            {ICE_LEVELS.map(l => <button key={l} type="button" onClick={() => setFormData({...formData, ice: l})} className={`px-4 py-2 rounded-xl text-[10px] font-bold whitespace-nowrap border transition-colors ${formData.ice === l ? theme.primary + ' text-white border-transparent' : 'bg-white text-gray-400 border-gray-100'}`}>{l}</button>)}
                                        </div>
                                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                            {SWEETNESS_LEVELS.map(l => <button key={l} type="button" onClick={() => setFormData({...formData, sweetness: l})} className={`px-4 py-2 rounded-xl text-[10px] font-bold whitespace-nowrap border transition-colors ${formData.sweetness === l ? theme.primary + ' text-white border-transparent' : 'bg-white text-gray-400 border-gray-100'}`}>{l}</button>)}
                                        </div>
                                    </div>
                                    <div className="flex gap-2 pt-4">
                                        <button type="submit" className={`flex-1 py-5 rounded-[2rem] text-white font-black shadow-lg ${theme.accent}`}>å„²å­˜ç´€éŒ„</button>
                                        {logs.find(l => l.date === selectedDate && l.userId === activeUserId) && (
                                            <button type="button" onClick={async () => {
                                                const ex = logs.find(l => l.date === selectedDate && l.userId === activeUserId);
                                                await window.fb.deleteDoc(window.fb.doc(window.fb.db, 'artifacts', window.fb.appId, 'public', 'data', 'logs', ex.id));
                                                setIsModalOpen(false);
                                            }} className="p-5 bg-red-50 text-red-500 rounded-[2rem] btn-active"><Icon name="Trash"/></button>
                                        )}
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
